<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento</title>
    <link rel="stylesheet" href="../css/pagamento.css">
</head>

<body>
    <div class="container">
        <h1>Pagamento</h1>
        <div class="area_externa">
            <!-- √Årea para selecionar o m√©todo de pagamento -->
            <div class="metodo-pagamento">
                <h2>Selecione um m√©todo de pagamento</h2>
                <div class="area-formulario">
                    <form id="form-pagamento" action="#" method="post">
                        <div class="form_caixa">
                            <h4>Seu Cart√£o</h4>
                            <!-- Cart√£o salvo (exibido via JS se existir) -->
                            <div class="imagem-no-input" id="area-cartao">
                                <button type="button" onclick="window.location.href='cartao.html'">+</button>
                                <div class="img-bandeiras">
                                    <img src="../imagens/pagamento/bandeiras.png" alt="Bandeiras">
                                </div>
                                <h6>Adicione um cart√£o ‚Äî Aceitamos diversas bandeiras.</h6>
                            </div>

                            <!-- Aqui os cart√µes ser√£o inseridos -->
                            <div id="cartoes-salvos"></div>

                            <div id="cartoes-salvos"></div>

                            <!-- Pix -->
                            <div class="imagem-no-input">
                                <input type="radio" name="metodo_pagamento" value="pix" id="pix">
                                <img class="img-pix" src="../imagens/pagamento/pix.png" alt="Pix">
                                <h6>O c√≥digo Pix √© v√°lido por 30 minutos ap√≥s a finaliza√ß√£o do pedido.</h6>
                            </div>
                            
                        </div>
                        
                        <!-- Bot√µes dentro do formul√°rio -->
                        <div class="botao-comp">
                            <button type="submit" class="submit-btn">Comprar</button>
                        </div>
                        
                        <div class="botao-cancel">
                            <a class="cancel-btn" href="detalhes.html">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- √Årea para o resumo da compra -->
            <div class="resumo-compra">
                <h2>Resumo da Compra</h2>
                <div class="area-resumo">
                    <div class="text-rsm">
                        <h3>ROTA A</h3>
                    </div>
                    <hr>
                    <div class="text-rsm">
                        <h4>Origem: Cidade A</h4>
                    </div>
                    <hr>
                    <div class="text-rsm">
                        <h4>Destino: Cidade B</h4>
                    </div>
                    <hr>
                    <div class="text-rsm">
                        <h4>Horario: 19:30</h4>
                    </div>
                    <hr>
                    <div class="valor-total">
                        <h4>Total:</h4>
                        <h4 class="valor">R$ 20.00</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="texto-inferior-direito">
            <a href="#" id="contact-link">precisa de ajuda ?</a>
        </div>

        <div id="contact-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <p>Email de contato: <a href="mailto:contato@plataforma.com">contato@plataforma.com</a></p>
            </div>
        </div>
    </div>
</body>
</html>

<script>

    const modal = document.getElementById("contact-modal");
    const contactLink = document.getElementById("contact-link");
    const closeBtn = document.querySelector(".close");

    contactLink.addEventListener("click", (e) => {
        e.preventDefault(); 
        modal.style.display = "block";
    });

    closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });

    window.addEventListener("click", (e) => {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
    // ========== UTILIT√ÅRIOS ==========
    const getRota = () =>
        JSON.parse(localStorage.getItem("rotaSelecionada")) || {
        nome: "Rota A",
        origem: "Cidade A",
        destino: "Cidade B",
        horario: "19:30",
        valor: "20.00"
        };

    const salvarPagamento = (pagamento) => {
        const pagamentos = JSON.parse(localStorage.getItem("pagamentos") || "[]");
        pagamentos.push(pagamento);
        localStorage.setItem("pagamentos", JSON.stringify(pagamentos));
    };

    async function enviarPagamentoBackend(pagamento) {
        const user = JSON.parse(sessionStorage.getItem("usuario_logado")) 
                || JSON.parse(localStorage.getItem("user"));

        if (!user || !user.id) {
            throw new Error("Usu√°rio n√£o est√° logado.");
        }

        const response = await fetch("http://localhost:3000/api/payments", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                tripId: pagamento.tripId,
                payerId: user.id,
                creditCardId: pagamento.creditCardId || null,
                value: Number(pagamento.valor),
                status: "APPROVED"  
            })
        });

        if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            console.error("Erro ao enviar pagamento:", err);
            throw new Error("Erro ao salvar pagamento no backend");
        }

        return response.json();
    }


    const exibirCartaoSalvo = async () => {
        const user = JSON.parse(localStorage.getItem("auth_user") || "{}");
        const cartao = await fetch(`http://localhost:3000/api/credit-cards/user/${user.id}`)
            .then(response => response.json())
            .then(data => {
                return data[0];
            })
            .catch(error => {
                console.error("Erro ao buscar cart√µes do usu√°rio:", error);
                return null;
            });
            if (!cartao) return;
            const final = cartao.maskedNumber.slice(-4);
            document.getElementById("area-cartao").innerHTML = `
            <div class="cartao-salvo">
                <input type="radio" name="metodo_pagamento" value="cartao" id="cartao" checked>
                <h6>${final} ‚Äî ${cartao.nickname}</h6>
                <button type="button" id="removerCartao" class="btn-remover">Remover</button>
            </div>
            `;

            document.getElementById("removerCartao").onclick = async () => {
            if (confirm("Remover este cart√£o?")) {
                await fetch(`http://localhost:3000/api/credit-cards/${cartao.id}`, {
                    method: "DELETE"
                });
                location.reload();
            }
        };
    };


    const preencherResumoRota = () => {
        const rota = getRota();
        const campos = {
        "nome-rota": rota.nome,
        "origem-rota": `Origem: ${rota.origem}`,
        "destino-rota": `Destino: ${rota.destino}`,
        "horario-rota": `Hor√°rio: ${rota.horario}`,
        "valor-rota": `R$ ${rota.valor}`
        };

        Object.entries(campos).forEach(([id, texto]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = texto;
        });
    };

    const configurarModalAjuda = () => {
        const modal = document.getElementById("contact-modal");
        document.getElementById("contact-link").onclick = (e) => {
        e.preventDefault();
        modal.style.display = "block";
        };
        document.querySelector(".close").onclick = () => (modal.style.display = "none");
        window.onclick = (e) => {
        if (e.target === modal) modal.style.display = "none";
        };
    };

    // ========== EVENTOS ==========
    document.getElementById("form-pagamento").addEventListener("submit", async (e) => {
    e.preventDefault();

        const metodo = document.querySelector('input[name="metodo_pagamento"]:checked');
        if (!metodo) return alert("Selecione um m√©todo de pagamento!");

        const rota = getRota();
        const valor = rota.valor;

        // üî• CHECK NECESS√ÅRIO
        if (!rota.idTrip) {
            return alert("Erro: rota n√£o possui tripId. Carregue a rota do backend!");
        }

        // =====================================================
        // üìå PAGAMENTO VIA PIX
        // =====================================================
        if (metodo.value === "pix") {

            const pagamentoPIX = {
                tripId: rota.idTrip,
                valor: valor,
                creditCardId: null
            };

            // guarda somente o necess√°rio
            localStorage.setItem("pagamentoAtual", JSON.stringify(pagamentoPIX));

            window.location.href = "pix.html";
            return;
        }

        // =====================================================
        // üìå PAGAMENTO COM CART√ÉO
        // =====================================================

        const cartaoSalvo = JSON.parse(localStorage.getItem("cartao"));

        if (!cartaoSalvo || !cartaoSalvo.id) {
            return alert("Nenhum cart√£o salvo encontrado.");
        }

        try {
            await enviarPagamentoBackend({
                tripId: rota.idTrip,
                creditCardId: cartaoSalvo.id,
                valor: valor
            });

            alert("Pagamento com cart√£o realizado com sucesso!");
            e.target.reset();

        } catch (err) {
            console.error(err);
            alert("Erro ao processar o pagamento.");
        }
    });


    window.onload = () => {
        preencherResumoRota();
        exibirCartaoSalvo();
        configurarModalAjuda();
    };


</script>