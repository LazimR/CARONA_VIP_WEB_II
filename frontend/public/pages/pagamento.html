<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento</title>
    <link rel="stylesheet" href="../css/pagamento.css">
</head>

<body>
    <div class="container">
        <h1>Pagamento</h1>
        <div class="area_externa">
            

            <!-- METODO DE PAGAMENTO -->
            <div class="metodo-pagamento">
                <h2>Selecione um método de pagamento</h2>
                <div class="area-formulario">
                    <form id="form-pagamento" action="#" method="post">
                        <div class="form_caixa">
                            <h4>Seu Cartão</h4>

                            <!-- CARTAO SALVO -->
                            <div class="imagem-no-input" id="area-cartao">
                                <button type="button" onclick="window.location.href='cartao.html'">+</button>
                                <div class="img-bandeiras">
                                    <img src="../imagens/pagamento/bandeiras.png" alt="Bandeiras">
                                </div>
                                <h6>Adicione um cartão — Aceitamos diversas bandeiras.</h6>
                            </div>

                            <div id="cartoes-salvos"></div>

                            <!-- PIX -->
                            <div class="imagem-no-input">
                                <input type="radio" name="metodo_pagamento" value="pix" id="pix">
                                <img class="img-pix" src="../imagens/pagamento/pix.png" alt="Pix">
                                <h6>O código Pix é válido por 30 minutos após a finalização do pedido.</h6>
                            </div>
                        </div>

                        <div class="botao-comp">
                            <button type="submit" class="submit-btn">Comprar</button>
                        </div>
                        <div class="botao-cancel">
                            <a class="cancel-btn" href="detalhes.html">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- RESUMO DA COMPRA -->
            <div class="resumo-compra">
                <h2>Resumo da Compra</h2>
                <div class="area-resumo">
                    <div class="text-rsm">
                        <h3 id="nome-rota">ROTA</h3>
                    </div>
                    <hr>
                    <div class="text-rsm">
                        <h4 id="origem-rota">Origem:</h4>
                    </div>
                    <hr>
                    <div class="text-rsm">
                        <h4 id="destino-rota">Destino:</h4>
                    </div>
                    <hr>
                    <div class="text-rsm">
                        <h4 id="horario-rota">Horário:</h4>
                    </div>
                    <hr>
                    <div class="valor-total">
                        <h4>Total:</h4>
                        <h4 class="valor" id="valor-rota">R$ --</h4>
                    </div>
                </div>
            </div>

        </div>

        <div class="texto-inferior-direito">
            <a href="#" id="contact-link">precisa de ajuda ?</a>
        </div>

        <div id="contact-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <p>Email de contato: <a href="mailto:contato@plataforma.com">contato@plataforma.com</a></p>
            </div>
        </div>
    </div>
</body>
</html>


<script>

async function registrarPaymentModel(pagamento) {
    const response = await fetch("http://localhost:3000/api/payment-models", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            tripId: pagamento.tripId,
            payerId: pagamento.payerId,
            creditCardId: pagamento.creditCardId,
            value: pagamento.value,
            status: "PAID",
            paymentDate: new Date().toISOString(),
            transactionId: crypto.randomUUID() // ID único
        })
    });

    if (!response.ok) {
        console.error(await response.json());
        throw new Error("Erro ao registrar payment-model");
    }
}

// ============================
// MODAL AJUDA
// ============================
const modal = document.getElementById("contact-modal");
document.getElementById("contact-link").onclick = (e) => {
    e.preventDefault();
    modal.style.display = "block";
};
document.querySelector(".close").onclick = () => (modal.style.display = "none");
window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };


// ============================
// BUSCAR DADOS DA TRIP
// ============================
async function carregarResumo() {
    const params = new URLSearchParams(window.location.search);
    const tripId = params.get("id");

    if (!tripId) {
        alert("Nenhuma viagem selecionada.");
        return;
    }

    try {
        const res = await fetch(`http://localhost:3000/api/trips/${tripId}`);
        const trip = await res.json();

        // Salvar informações para pagamento
        localStorage.setItem(
            "rotaSelecionada",
            JSON.stringify({
                idTrip: trip.id,
                nome: "Rota " + (trip.route?.id || ""),
                origem: trip.route?.origin,
                destino: trip.route?.destination,
                horario: new Date(trip.departureAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }),
                valor: trip.pricePerPerson
            })
        );

        // Preencher resumo
        document.getElementById("nome-rota").textContent = "Rota " + (trip.route?.id || "A");
        document.getElementById("origem-rota").textContent = "Origem: " + trip.route?.origin;
        document.getElementById("destino-rota").textContent = "Destino: " + trip.route?.destination;
        document.getElementById("horario-rota").textContent =
            "Horário: " + new Date(trip.departureAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        document.getElementById("valor-rota").textContent = "R$ " + trip.pricePerPerson.toFixed(2);

    } catch (err) {
        console.error(err);
        alert("Erro ao carregar dados da viagem.");
    }
}



// ============================
// CARTÃO SALVO
// ============================
async function exibirCartaoSalvo() {
    const user = JSON.parse(localStorage.getItem("auth_user") || "{}");

    const cartao = await fetch(`http://localhost:3000/api/credit-cards/user/${user.id}`)
        .then(r => r.json())
        .then(d => d[0])
        .catch(() => null);

    if (!cartao) return;

    sessionStorage.setItem("cartao", JSON.stringify(cartao));
    const final = cartao.maskedNumber.slice(-4);


    document.getElementById("area-cartao").innerHTML = `
        <div class="cartao-salvo">
            <input type="radio" name="metodo_pagamento" value="cartao" checked>
            <h6>${final} — ${cartao.nickname}</h6>
            <button type="button" id="removerCartao" class="btn-remover">Remover</button>
        </div>
    `;

    document.getElementById("removerCartao").onclick = async () => {
        if (confirm("Remover este cartão?")) {
            await fetch(`http://localhost:3000/api/credit-cards/${cartao.id}`, { method: "DELETE" });
            location.reload();
        }
    };
}





// ============================
// SUBMIT DO FORMULÁRIO
// ============================
document.getElementById("form-pagamento").addEventListener("submit", async (e) => {
    e.preventDefault();

    const metodo = document.querySelector('input[name="metodo_pagamento"]:checked');
    if (!metodo) return alert("Selecione um método de pagamento!");

    const rota = JSON.parse(localStorage.getItem("rotaSelecionada"));
    const user = JSON.parse(localStorage.getItem("auth_user") || "{}");

    if (!rota?.idTrip) return alert("Erro ao recuperar dados da viagem.");
    if (!user?.id) return alert("Faça login antes de pagar.");

    const valor = rota.valor;

    // -------------------------
    // SE FOR PIX → só redireciona
    // -------------------------
    if (metodo.value === "pix") {
        localStorage.setItem("pagamentoAtual", JSON.stringify({
            tripId: rota.idTrip,
            value: valor
        }));

        window.location.href = "pix.html";
        return;
    }

    // -------------------------
    // PAGAMENTO COM CARTÃO
    // -------------------------
    const cartaoSalvo = JSON.parse(sessionStorage.getItem("cartao"));
    if (!cartaoSalvo?.id) return alert("Nenhum cartão salvo.");

    try {
        // 1️⃣ Criar payment-model
        await registrarPaymentModel({
            tripId: rota.idTrip,
            payerId: user.id,
            creditCardId: cartaoSalvo.id,
            value: valor
        });

        // 2️⃣ Registrar passageiro na viagem
        await fetch("http://localhost:3000/api/trip-passengers", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                tripId: rota.idTrip,
                passengerId: user.id,
                status: "PENDING"
            })
        });

        alert("Pagamento realizado e viagem reservada com sucesso!");
        window.location.href = "index.html";

    } catch (err) {
        console.error(err);
        alert("Erro ao processar pagamento ou reservar viagem.");
    }
});



// ============================
// ON LOAD
// ============================
window.onload = () => {
    carregarResumo();
    exibirCartaoSalvo();
};
</script>
