<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento da Carona</title>
    <link rel="stylesheet" href="/css/pix.css">
</head>
<body>
    <div class="principal">
        <!-- Header com Logo -->
        <header class="header-pagamento">
            <div class="logo-container">
                <img src="/imagens/home/sessao_01/logo.jpeg" alt="Logo Carona Certa" class="logo-img">
            </div>
        </header>

        <!-- Título e Instruções -->
        <div class="titulo-section">
            <h1>Pagamento da Carona</h1>
            <p class="instrucao">Finalize o pagamento via Pix para confirmar sua vaga.</p>
        </div>

        <!-- Detalhes da Carona -->
        <div class="detalhes-carona">
            <div class="detalhe-item">
                <span class="detalhe-label">Motorista:</span>
                <span class="detalhe-value" id="motorista-name">João Silva</span>
            </div>
            <div class="detalhe-item">
                <span class="detalhe-label">Destino:</span>
                <span class="detalhe-value" id="destino-route">Picos → Teresina</span>
            </div>
            <div class="detalhe-item">
                <span class="detalhe-label">Horário:</span>
                <span class="detalhe-value" id="horario-viagem">Hoje às 14:00</span>
            </div>
            <div class="detalhe-item">
                <span class="detalhe-label">Valor da Carona:</span>
                <span class="detalhe-value" id="valor-carona">R$ 25,00</span>
            </div>
        </div>

        <!-- Container para gerar PIX (inicialmente visível) -->
        <div class="container-gerar" id="container-gerar">
            <button id="pay-button" class="btn-gerar-pix">Gerar Pix</button>
        </div>

        <!-- Container do QR Code (inicialmente oculto) -->
        <div id="pix-container" class="container-qrcode" style="display: none;">
            <h3 class="qrcode-title">QR Code Gerado</h3>
            <p class="qrcode-instruction">Aponte a câmera do celular para pagar</p>
            
            <div class="qrcode-wrapper">
                <div class="qrcode-image-container">
                    <img id="qr-code-img" src="" alt="PIX QR Code" class="qr-code-img">
                </div>
                <div class="qrcode-code-container">
                    <div class="code-lines" id="code-lines">
                        <div class="code-line"></div>
                        <div class="code-line"></div>
                    </div>
                    <input type="text" id="qr-code-text" readonly class="qr-code-text" style="display: none;">
                    <button id="copy-button" type="button" class="btn-copiar-codigo">Copiar código</button>
                </div>
            </div>
        </div>

        <!-- Status do Pagamento -->
        <div class="status-section">
            <p class="status-label">Status:</p>
            <p class="status-value" id="payment-status">Aguardando pagamento...</p>
        </div>

        <!-- Botão Cancelar -->
        <div class="area-botoes">
            <button type="button" class="btn-cancel">Cancelar</button>
        </div>
    </div>
    
    <script>
        const payButton = document.getElementById('pay-button');
        const copyButton = document.getElementById('copy-button');
        const pixContainer = document.getElementById('pix-container');
        const qrCodeImg = document.getElementById('qr-code-img');
        const qrCodeText = document.getElementById('qr-code-text');
        const containerGerar = document.getElementById('container-gerar');
        const paymentStatus = document.getElementById('payment-status');
        const valorCaronaElement = document.getElementById('valor-carona');

        let currentPaymentId = null;
        let statusCheckInterval = null;

        // Quando clicar em "Gerar PIX"
        payButton.addEventListener('click', async () => {
            try {
                // Extrai o valor da carona do texto (ex: "R$ 25,00" -> 25.00)
                const valorTexto = valorCaronaElement.textContent.replace('R$', '').replace(',', '.').trim();
                const amount = parseFloat(valorTexto);
                const description = 'Carona VIP - ' + document.getElementById('destino-route').textContent;

                if (!amount || amount <= 0) {
                    alert('Por favor, verifique o valor da carona.');
                    return;
                }

                // Mostra loading
                payButton.textContent = 'Gerando...';
                payButton.disabled = true;

                // Chama o backend
                const response = await fetch('http://localhost:3000/create-pix-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        amount: amount,
                        description: description
                    })
                });
    
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || 'Falha ao gerar PIX');
                }
    
                const pixData = await response.json();
                currentPaymentId = pixData.payment_id;
    
                // Preenche os dados do PIX na tela
                qrCodeImg.src = `data:image/png;base64,${pixData.qr_code_base64}`;
                qrCodeText.value = pixData.qr_code_text;
                paymentStatus.textContent = 'Aguardando pagamento...';
    
                // Atualiza as linhas do código PIX
                const codeLines = document.getElementById('code-lines');
                const pixCode = pixData.qr_code_text;
                // Divide o código em duas linhas (aproximadamente)
                const midPoint = Math.floor(pixCode.length / 2);
                codeLines.innerHTML = `
                    <div class="code-line-text">${pixCode.substring(0, midPoint)}</div>
                    <div class="code-line-text">${pixCode.substring(midPoint)}</div>
                `;
    
                // Mostra/Esconde os elementos corretos
                containerGerar.style.display = 'none';
                pixContainer.style.display = 'block';
                copyButton.style.display = 'block';

                // Inicia verificação automática de status
                startStatusCheck();
    
            } catch (error) {
                console.error('Erro ao chamar o backend:', error);
                alert('Erro ao gerar PIX: ' + error.message);
                payButton.textContent = 'Gerar Pix';
                payButton.disabled = false;
            }
        });

        // Função para verificar status do pagamento
        async function checkPaymentStatus() {
            if (!currentPaymentId) return;

            try {
                const response = await fetch(`http://localhost:3000/payment-status/${currentPaymentId}`);
                
                if (!response.ok) {
                    throw new Error('Erro ao verificar status');
                }

                const statusData = await response.json();
                
                // Atualiza o status na tela
                const statusMap = {
                    'pending': 'Aguardando pagamento...',
                    'approved': 'Pagamento aprovado!',
                    'rejected': 'Pagamento rejeitado',
                    'cancelled': 'Pagamento cancelado',
                    'refunded': 'Pagamento estornado'
                };

                paymentStatus.textContent = statusMap[statusData.status] || statusData.status;

                // Se pagamento foi aprovado, para a verificação automática
                if (statusData.status === 'approved') {
                    stopStatusCheck();
                    alert('Pagamento aprovado com sucesso!');
                }

            } catch (error) {
                console.error('Erro ao verificar status:', error);
            }
        }

        // Inicia verificação automática de status
        function startStatusCheck() {
            stopStatusCheck(); // Para qualquer verificação anterior
            statusCheckInterval = setInterval(checkPaymentStatus, 5000); // Verifica a cada 5 segundos
        }

        // Para verificação automática de status
        function stopStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        }
    
        // Funcionalidade do botão "Copiar"
        copyButton.addEventListener('click', () => {
            qrCodeText.style.display = 'block';
            qrCodeText.select();
            document.execCommand('copy');
            qrCodeText.style.display = 'none';
            alert('Código PIX copiado!');
        });

        // Botão "Cancelar"
        document.querySelector('.btn-cancel').addEventListener('click', () => {
            stopStatusCheck();
            window.history.back();
        });

        // Limpa recursos quando a página é fechada
        window.addEventListener('beforeunload', () => {
            stopStatusCheck();
        });
    </script>
</body>
</html>