<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Cadastro de usuário</title>
        <link rel="stylesheet" href="../css/styles.css">
    </head>


    <body>
        <div class="container">
            <!-- Lado Esquerdo -->
                <div class="esquerda">
                <img src="../imagens/cadastro_usuario/cadastro_usuario.png" alt="Homem pegando no volante">
            </div>

             <!-- Lado direito -->
            <div class="direita">
                <div class="form-container">
                    <h3>BEM-VINDO</h3>
                    <h6>CADASTRE-SE</h6>
                    <form action="#" method="post">

                        <div class="form-group">
                            <div class="imagem-no-input">
                                <img src="../imagens/cadastro_usuario/usuario.png" alt="Ícone">
                                <input type="text" id="nome" name="nome" placeholder="Nome completo" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="imagem-no-input">
                                <img src="../imagens/cadastro_usuario/cpf.png" alt="Ícone">
                                <input type="text" id="phone" name="phone" placeholder="Telefone (opcional)" maxlength="15">
                            </div>
                        </div>


                        <div class="form-group">
                            <div class="imagem-no-input">
                                <img src="../imagens/cadastro_usuario/email.png" alt="Ícone">
                                <input type="email" id="email" name="email" placeholder="E-mail" required>
                            </div>
                        </div>

                        
                        <div class="form-group">
                            <div class="imagem-no-input">
                                <img src="../imagens/cadastro_usuario/senha.png" alt="Ícone">
                                <input type="password" id="senha_usuario" name="senha_usuario" placeholder="Senha" required>
                            </div>
                        </div>


                        <div class="form-group">
                            <div class="imagem-no-input">
                                <img src="../imagens/cadastro_usuario/branco.png" alt="Ícone">
                                <input type="password" id="confirma_senha" name="confirma_senha" placeholder="Confirmar Senha" required>
                            </div>
                        </div>


                        <div class="form-group">
                            <div class="imagem-no-input">
                                <img id="seta-direita" src="../imagens/cadastro_motorista/seta.png" alt="Ícone">
                                <button type="submit" class="submit-btn" id="submitBtn">Torne-se um membro</button>
                            </div>
                        </div>
                        <div id="errorMessage" style="display: none; color: red; margin-top: 10px; text-align: center; font-size: 14px;"></div>
                    </form>
                </div>

            </div>
        </div>
        <div class="texto-inferior-direito">
            <img src="../imagens/cadastro_motorista/info.png" alt="Ícone de ajuda">
            <a href="#" id="contact-link">precisa de ajuda ?</a>
        </div>

        <div class="texto-superior-direito">
            <p>Já é membro? <a href="login.html"><b>Faça Login</b></a></p>
        </div>

        <div class="texto-superior-esquerdo">
            <img src="../imagens/login/seta_esquerda.png" alt= "seta esquerda">
            <a href="index.html">Retornar ao Menu</a>
        </div>

        <div id="contact-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <p>Email de contato: <a href="mailto:contato@plataforma.com">contato@plataforma.com</a></p>
            </div>
        </div>
    </body>
</html> 

<script>
    const modal = document.getElementById("contact-modal");
    const contactLink = document.getElementById("contact-link");
    const closeBtn = document.querySelector(".close");

    contactLink.addEventListener("click", (e) => {
        e.preventDefault(); 
        modal.style.display = "block";
    });

    closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });

    window.addEventListener("click", (e) => {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });

    // ========== CONFIGURAÇÃO DA API ==========
    const API_URL = 'http://localhost:3000';

    // ========== VALIDAÇÃO DE FORMULÁRIOS ==========

    // Validação de Email
    function validarEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }

    // Validação de Senha (backend requer mínimo 6 caracteres)
    function validarSenha(senha) {
        return senha && senha.length >= 6;
    }

    // Formatação de Telefone (máscara simples)
    function formatarTelefone(telefone) {
        telefone = telefone.replace(/\D/g, '');
        if (telefone.length <= 10) {
            return telefone.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
        } else {
            return telefone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }
    }

    // Aplicar máscara de telefone
    const phoneInput = document.getElementById("phone");
    if (phoneInput) {
        phoneInput.addEventListener("input", function(e) {
            e.target.value = formatarTelefone(e.target.value);
        });
    }

    // Validação em tempo real
    document.getElementById("email").addEventListener("blur", function(e) {
        const email = e.target.value;
        if (email && !validarEmail(email)) {
            e.target.setCustomValidity("Email inválido");
            e.target.reportValidity();
        } else {
            e.target.setCustomValidity("");
        }
    });

    document.getElementById("senha_usuario").addEventListener("blur", function(e) {
        const senha = e.target.value;
        if (senha && !validarSenha(senha)) {
            e.target.setCustomValidity("Senha deve ter no mínimo 6 caracteres");
            e.target.reportValidity();
        } else {
            e.target.setCustomValidity("");
        }
    });

    document.getElementById("confirma_senha").addEventListener("blur", function(e) {
        const senha = document.getElementById("senha_usuario").value;
        const confirmaSenha = e.target.value;
        if (confirmaSenha && senha !== confirmaSenha) {
            e.target.setCustomValidity("As senhas não coincidem");
            e.target.reportValidity();
        } else {
            e.target.setCustomValidity("");
        }
    });

    // ========== FUNÇÕES DE ARMAZENAMENTO ==========

    function salvarToken(token) {
        localStorage.setItem('auth_token', token);
    }

    function salvarUsuario(user) {
        localStorage.setItem('auth_user', JSON.stringify(user));
    }

    // ========== FORMULÁRIO DE CADASTRO ==========

    document.querySelector("form").addEventListener("submit", async function(e) {
        e.preventDefault();

        const nome = document.getElementById("nome").value.trim();
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone")?.value.replace(/\D/g, '') || '';
        const senha = document.getElementById("senha_usuario").value;
        const confirmaSenha = document.getElementById("confirma_senha").value;
        const errorDiv = document.getElementById("errorMessage");
        const submitBtn = document.getElementById("submitBtn");

        // Esconder mensagem de erro anterior
        errorDiv.style.display = "none";
        errorDiv.textContent = "";

        // Validações
        if (!nome || nome.length < 3) {
            errorDiv.textContent = "Nome deve ter no mínimo 3 caracteres";
            errorDiv.style.display = "block";
            return;
        }

        if (!validarEmail(email)) {
            errorDiv.textContent = "Email inválido";
            errorDiv.style.display = "block";
            return;
        }

        if (!validarSenha(senha)) {
            errorDiv.textContent = "Senha deve ter no mínimo 6 caracteres";
            errorDiv.style.display = "block";
            return;
        }

        if (senha !== confirmaSenha) {
            errorDiv.textContent = "As senhas não coincidem";
            errorDiv.style.display = "block";
            return;
        }

        // Desabilitar botão e mostrar loading
        submitBtn.disabled = true;
        submitBtn.textContent = "Criando conta...";

        try {
            // Preparar dados para cadastro conforme API do backend
            const registerData = {
                name: nome,
                email: email,
                password: senha
            };

            // Adicionar telefone se preenchido
            if (phone) {
                registerData.phone = phone;
            }

            // Fazer requisição para API de cadastro
            const response = await fetch(`${API_URL}/api/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(registerData)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'Erro ao cadastrar usuário');
            }

            // Armazenar token e dados do usuário (o backend já retorna após cadastro)
            salvarToken(data.token);
            salvarUsuario(data.user);

            // Salvar no sessionStorage para compatibilidade
            sessionStorage.setItem("usuario_logado", JSON.stringify({
                usuario: data.user.name,
                email: data.user.email
            }));

            console.log("Cadastro realizado com sucesso:", data.user);

            alert("Cadastro realizado com sucesso! Você já está logado.");

            // Redirecionar para página inicial (já está autenticado)
            window.location.href = "index.html";
        } catch (error) {
            console.error("Erro ao cadastrar:", error);
            errorDiv.textContent = error.message || "Erro ao cadastrar. Tente novamente.";
            errorDiv.style.display = "block";
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Torne-se um membro";
        }
    });

</script>