<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="../css/styles.css">
    </head>


    <body>
        <div class="tamanho_fundo">
            <div class="container">
                <!-- Lado Esquerdo -->
                <div class="esquerda">
                    <img src="../imagens/login/login.png" alt="Homem pegando no volante">
                </div>

                <div class="direita">
                    <div class="form-container">
                        <h3>BEM-VINDO</h3>
                        <h6>Faça login para continuar</h6>
                        <form action="#" method="post" id="loginForm">

                            
                            <div class="form-group">
                                <div class="imagem-no-input">
                                    <img src="../imagens/login/usuario.png" alt="Ícone">
                                    <input type="email" id="email" name="email" placeholder="Email" required>
                                </div>
                            </div>


                            <div class="form-group">
                                <div class="imagem-no-input">
                                    <img src="../imagens/login/senha.png" alt="Ícone">
                                    <input type="password" id="senha" name="senha" placeholder="Senha" required>
                                </div>
                            </div>


                            <div class="form-group">
                                <div class="imagem-no-input">
                                    <img id="seta-direita" src="../imagens/cadastro_motorista/seta.png" alt="Ícone">
                                    <button type="submit" class="submit-btn" id="submitBtn">Entrar</button>
                                </div>
                            </div>
                            <div id="errorMessage" style="display: none; color: red; margin-top: 10px; text-align: center; font-size: 14px;"></div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
        <div class="texto-inferior-direito">
            <img src="../imagens/cadastro_motorista/info.png" alt="Ícone de ajuda">
            <a href="#" id="contact-link">precisa de ajuda ?</a>
        </div>

        <div class="texto-superior-direito">
            <p>Ainda não é membro? <a href="cadastro_usuario.html"><b>CADASTRE-SE AGORA</b></a></p>
        </div>

        <div class="texto-superior-esquerdo">
            <img src="../imagens/login/seta_esquerda.png" alt= "seta esquerda">
            <a href="index.html">Retornar ao Menu</a>
        </div>

        <div id="contact-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <p>Email de contato: <a href="mailto:contato@plataforma.com">contato@plataforma.com</a></p>
            </div>
        </div>
    </body>
</html> 

<script>
    const modal = document.getElementById("contact-modal");
    const contactLink = document.getElementById("contact-link");
    const closeBtn = document.querySelector(".close");

    contactLink.addEventListener("click", (e) => {
        e.preventDefault(); 
        modal.style.display = "block";
    });

    closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });

    window.addEventListener("click", (e) => {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });

    // ========== CONFIGURAÇÃO DA API ==========
    const API_URL = 'http://localhost:3000';

    // ========== VALIDAÇÃO DE FORMULÁRIOS ==========

    function validarEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }

    function validarSenha(senha) {
        return senha && senha.length >= 6; // Backend requer mínimo 6 caracteres
    }

    // Validação em tempo real
    document.getElementById("email").addEventListener("blur", function(e) {
        const email = e.target.value;
        if (email && !validarEmail(email)) {
            e.target.setCustomValidity("Email inválido");
            e.target.reportValidity();
        } else {
            e.target.setCustomValidity("");
        }
    });

    document.getElementById("senha").addEventListener("blur", function(e) {
        const senha = e.target.value;
        if (senha && !validarSenha(senha)) {
            e.target.setCustomValidity("Senha deve ter no mínimo 6 caracteres");
            e.target.reportValidity();
        } else {
            e.target.setCustomValidity("");
        }
    });


    // ========== FUNÇÕES DE ARMAZENAMENTO ==========

    function salvarToken(token) {
        localStorage.setItem('auth_token', token);
    }

    function salvarUsuario(user) {
        localStorage.setItem('auth_user', JSON.stringify(user));
    }

    function obterToken() {
        return localStorage.getItem('auth_token');
    }

    function obterUsuario() {
        const userStr = localStorage.getItem('auth_user');
        return userStr ? JSON.parse(userStr) : null;
    }

    function limparAutenticacao() {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('auth_user');
        sessionStorage.removeItem('usuario_logado');
    }

    // ========== FORMULÁRIO DE LOGIN ==========

    document.getElementById("loginForm").addEventListener("submit", async function(e) {
        e.preventDefault();

        const email = document.getElementById("email").value.trim();
        const senha = document.getElementById("senha").value;
        const errorDiv = document.getElementById("errorMessage");
        const submitBtn = document.getElementById("submitBtn");

        // Esconder mensagem de erro anterior
        errorDiv.style.display = "none";
        errorDiv.textContent = "";

        // Validações
        if (!validarEmail(email)) {
            errorDiv.textContent = "Email inválido";
            errorDiv.style.display = "block";
            return;
        }

        if (!validarSenha(senha)) {
            errorDiv.textContent = "Senha deve ter no mínimo 6 caracteres";
            errorDiv.style.display = "block";
            return;
        }

        // Desabilitar botão e mostrar loading
        submitBtn.disabled = true;
        submitBtn.textContent = "Entrando...";

        try {
            // Fazer requisição para API de login
            const response = await fetch(`${API_URL}/api/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    password: senha
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'Erro ao fazer login');
            }

            // Armazenar token e dados do usuário
            salvarToken(data.token);
            salvarUsuario(data.user);

            // Salvar no sessionStorage para compatibilidade
            sessionStorage.setItem("usuario_logado", JSON.stringify({
                usuario: data.user.name,
                email: data.user.email
            }));

            // Salvar último email usado
            localStorage.setItem("ultimo_email_login", email);

            console.log("Login realizado com sucesso:", data.user);

            // Redirecionar para página inicial
            window.location.href = "index.html";
        } catch (error) {
            console.error("Erro ao realizar login:", error);
            errorDiv.textContent = error.message || "Erro ao realizar login. Verifique suas credenciais.";
            errorDiv.style.display = "block";
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Entrar";
        }
    });

    // ========== VERIFICAR SESSÃO EXISTENTE ==========

    window.addEventListener("load", () => {
        // Verificar se já existe token armazenado
        const token = obterToken();
        const usuario = obterUsuario();

        if (token && usuario) {
            console.log("Usuário já autenticado:", usuario.email);
        }

        // Carregar último email usado
        const ultimoEmail = localStorage.getItem("ultimo_email_login");
        if (ultimoEmail && document.getElementById("email")) {
            document.getElementById("email").value = ultimoEmail;
        }
    });

    // ========== LOGOUT ==========

    function logout() {
        limparAutenticacao();
        window.location.href = "login.html";
    }

    // Expor função de logout globalmente (caso precise ser chamada de outras páginas)
    window.logout = logout;

</script>